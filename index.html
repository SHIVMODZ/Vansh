<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BotHost — Single File</title>
  <meta name="description" content="Single-file bot hosting frontend demo (static). Save as index.html and open in your browser." />
  <style>
    :root{--bg:#071022;--card:#0b1220;--accent:#4f46e5;--muted:#94a3b8;--text:#e6eef8}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#071029 0%, #071727 100%);color:var(--text);min-height:100vh}
    .container{max-width:1000px;margin:0 auto;padding:20px}
    .site-header{background:rgba(255,255,255,0.02);padding:12px 0;position:sticky;top:0;backdrop-filter:blur(6px);z-index:10}
    .site-header .container{display:flex;align-items:center;justify-content:space-between}
    .logo{margin:0;font-size:20px;color:var(--accent)}
    nav .btn{margin-left:8px;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    nav .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .hero{padding:24px 0}
    .hero h2{margin:0 0 6px;font-size:28px}
    .hero p{color:var(--muted)}
    .dashboard{margin-top:20px}
    .bots-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .card h4{margin:0 0 6px;display:flex;align-items:center;justify-content:space-between}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .card .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn.small{padding:6px 8px;font-size:13px;border-radius:8px}
    .btn.danger{background:#ef4444;color:white;border:0}
    .docs{margin-top:28px;color:var(--muted);background:rgba(255,255,255,0.01);padding:12px;border-radius:8px}
    .note{margin-top:8px;color:#f8d7a8}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);padding:20px}
    .modal.hidden{display:none}
    .modal-content{background:#071122;padding:18px;border-radius:10px;min-width:320px;max-width:720px;border:1px solid rgba(255,255,255,0.03)}
    .modal-close{float:right;background:transparent;border:0;color:var(--muted);font-size:20px;cursor:pointer}
    .modal-content label{display:block;margin-top:10px}
    .modal-content input[type="text"], .modal-content input[type="file"], .modal-content textarea, .modal-content select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    footer{padding:18px 0;color:var(--muted);font-size:13px;text-align:center}
    .small-muted{font-size:12px;color:var(--muted)}
    .flex-row{display:flex;gap:8px;align-items:center}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
    .badge{background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    @media (max-width:520px){ .site-header .container{flex-direction:column;gap:8px;align-items:flex-start} }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">BotHost</h1>
      <nav>
        <button id="newBotBtn" class="btn">Create Bot</button>
        <button id="refreshBtn" class="btn ghost">Refresh</button>
      </nav>
    </div>
  </header>

  <main class="container" id="main">
    <section class="hero">
      <h2>Host, run and manage your bots (single-file demo)</h2>
      <p>Demo uses localStorage when no backend is configured. To use a real backend set BACKEND_URL in the script below.</p>
    </section>

    <section class="dashboard" aria-labelledby="botsHeading">
      <h3 id="botsHeading">Your Bots <span id="botsCount" class="badge">0</span></h3>
      <div id="botsList" class="bots-grid" aria-live="polite">
        <!-- Bot cards injected here -->
      </div>
    </section>

    <section class="docs">
      <h3>Notes</h3>
      <ol>
        <li>Local demo: data stored in localStorage key "bothost_bots_v1".</li>
        <li>To enable a live backend set BACKEND_URL variable in the script to your API base (e.g. https://example.com).</li>
        <li>Backend endpoints expected (standard): GET /api/bots, POST /api/bots (multipart/form-data name,description,file),
            POST /api/bots/:id/start, POST /api/bots/:id/stop, DELETE /api/bots/:id, GET /api/bots/:id/logs</li>
        <li>Running uploaded code is dangerous. Use containers, resource limits, network restrictions, and strong auth in production.</li>
      </ol>
    </section>
  </main>

  <!-- Create Bot Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content" role="document">
      <button id="closeModal" class="modal-close" aria-label="Close modal">&times;</button>
      <h3 id="modalTitle">Create Bot</h3>
      <form id="botForm">
        <label>
          Bot name
          <input type="text" name="name" id="botName" required placeholder="My Bot" />
        </label>
        <label>
          Description
          <input type="text" name="description" id="botDesc" placeholder="What this bot does" />
        </label>
        <label>
          Runtime (informational)
          <select id="botRuntime">
            <option value="node">Node.js</option>
            <option value="python">Python</option>
            <option value="go">Go</option>
            <option value="other">Other</option>
          </select>
        </label>
        <label>
          Upload file (zip, tar, single file) — optional
          <input type="file" id="botFile" aria-describedby="fileHelp" />
          <div id="fileHelp" class="small-muted">File is uploaded only when BACKEND_URL is configured.</div>
        </label>
        <div class="form-actions">
          <button type="submit" class="btn">Create</button>
          <button type="button" id="closeBtn" class="btn ghost">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Simple logs modal -->
  <div id="logsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="logsTitle">
    <div class="modal-content">
      <button id="closeLogs" class="modal-close" aria-label="Close logs">&times;</button>
      <h3 id="logsTitle">Logs</h3>
      <pre id="logsContent" style="max-height:360px;overflow:auto;background:rgba(255,255,255,0.02);padding:10px;border-radius:6px;color:var(--muted)"></pre>
      <div style="text-align:right;margin-top:8px">
        <button id="downloadLogs" class="btn ghost">Download</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container small-muted">Demo — no backend required. Save as index.html and open in your browser.</div>
  </footer>

  <script>
  /************************************************************************
   * Single-file BotHost frontend
   *
   * BACKEND_URL = '' -> localStorage demo mode
   * Set BACKEND_URL to your API base (no trailing slash) to enable server mode
   *
   * Expected backend endpoints (standard):
   *   GET  /api/bots
   *   POST /api/bots (multipart/form-data: name, description, file)
   *   POST /api/bots/:id/start
   *   POST /api/bots/:id/stop
   *   DELETE /api/bots/:id
   *   GET  /api/bots/:id/logs
   *
   * This file is a demo. Do NOT run untrusted uploaded code on public infrastructure.
   ************************************************************************/

  const BACKEND_URL = ''; // <-- set to your backend base URL, e.g. 'https://api.example.com'

  const LS_KEY = 'bothost_bots_v1';
  const modal = document.getElementById('modal');
  const newBotBtn = document.getElementById('newBotBtn');
  const closeModalBtn = document.getElementById('closeModal');
  const closeBtn = document.getElementById('closeBtn');
  const botForm = document.getElementById('botForm');
  const botsListEl = document.getElementById('botsList');
  const refreshBtn = document.getElementById('refreshBtn');
  const botsCountEl = document.getElementById('botsCount');

  const logsModal = document.getElementById('logsModal');
  const closeLogs = document.getElementById('closeLogs');
  const logsContent = document.getElementById('logsContent');
  const downloadLogs = document.getElementById('downloadLogs');

  let bots = [];

  // ---------- storage / backend helpers ----------
  async function fetchBackend(path, opts = {}) {
    if (!BACKEND_URL) throw new Error('No backend configured');
    const url = BACKEND_URL + path;
    const res = await fetch(url, opts);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Server error ${res.status}: ${text}`);
    }
    return res.json();
  }

  function loadLocal() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      console.warn('Failed to parse local storage data', e);
      return [];
    }
  }

  function saveLocal(data) {
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }

  async function loadBots() {
    if (BACKEND_URL) {
      try {
        const data = await fetchBackend('/api/bots');
        bots = Array.isArray(data) ? data : [];
      } catch (e) {
        console.error('Failed to fetch from backend, falling back to local:', e);
        bots = loadLocal();
      }
    } else {
      bots = loadLocal();
    }
  }

  async function persistCreate(formData, localEntry) {
    if (BACKEND_URL && formData) {
      // Post to backend
      try {
        const res = await fetch(BACKEND_URL + '/api/bots', { method: 'POST', body: formData });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || 'Upload failed');
        }
        const created = await res.json();
        return created;
      } catch (e) {
        alert('Upload to backend failed: ' + e.message + '. Bot saved locally.');
        // fallthrough to local save
      }
    }
    // local save
    const db = loadLocal();
    db.push(localEntry);
    saveLocal(db);
    return localEntry;
  }

  async function persistUpdateStatus(id, status) {
    if (BACKEND_URL) {
      try {
        const endpoint = status === 'running' ? '/start' : '/stop';
        await fetchBackend(`/api/bots/${encodeURIComponent(id)}${endpoint}`, { method: 'POST' });
        return true;
      } catch (e) {
        console.error('Backend start/stop failed', e);
        return false;
      }
    } else {
      const db = loadLocal();
      const b = db.find(x => x.id === id);
      if (b) { b.status = status; saveLocal(db); return true; }
      return false;
    }
  }

  async function persistDelete(id) {
    if (BACKEND_URL) {
      try {
        await fetchBackend(`/api/bots/${encodeURIComponent(id)}`, { method: 'DELETE' });
        return true;
      } catch (e) {
        console.error('Backend delete failed', e);
        return false;
      }
    } else {
      let db = loadLocal();
      db = db.filter(x => x.id !== id);
      saveLocal(db);
      return true;
    }
  }

  async function fetchLogs(id) {
    if (BACKEND_URL) {
      try {
        const res = await fetch(BACKEND_URL + `/api/bots/${encodeURIComponent(id)}/logs`);
        if (!res.ok) throw new Error('Failed to fetch logs: ' + res.status);
        const text = await res.text();
        return text;
      } catch (e) {
        console.error(e);
        return `Failed to fetch logs: ${e.message}`;
      }
    } else {
      // local demo logs
      return `Demo logs for bot ${id}\n---\nNo real backend configured.`;
    }
  }

  // ---------- rendering ----------
  function escapeHTML(s) {
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function updateCount() {
    botsCountEl.textContent = String(bots.length || 0);
  }

  function renderBots() {
    botsListEl.innerHTML = '';
    updateCount();
    if (!bots.length) {
      botsListEl.innerHTML = '<div class="card"><p class="small-muted">No bots yet. Click "Create Bot" to add one.</p></div>';
      return;
    }
    bots.forEach(b => {
      const card = document.createElement('div');
      card.className = 'card';
      const idLabel = `<small style="color:var(--muted);font-size:12px">${escapeHTML(b.id || '')}</small>`;
      const statusText = b.status || 'stopped';
      card.innerHTML = `
        <h4>${escapeHTML(b.name || 'Untitled')} ${idLabel}</h4>
        <p>${escapeHTML(b.desc || '')}</p>
        <div class="actions">
          <button class="btn small" data-action="start" data-id="${escapeHTML(b.id)}">${statusText === 'running' ? 'Restart' : 'Start'}</button>
          <button class="btn small ghost" data-action="logs" data-id="${escapeHTML(b.id)}">Logs</button>
          <button class="btn small ghost" data-action="download" data-id="${escapeHTML(b.id)}">Download</button>
          <button class="btn small danger" data-action="delete" data-id="${escapeHTML(b.id)}">Delete</button>
        </div>
        <p style="color:var(--muted);font-size:12px;margin-top:8px">Status: ${escapeHTML(statusText)}</p>
      `;
      botsListEl.appendChild(card);
    });
  }

  // ---------- UI actions ----------
  newBotBtn.addEventListener('click', () => {
    modal.classList.remove('hidden');
    document.getElementById('botName').focus();
  });
  closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
  closeBtn.addEventListener('click', () => modal.classList.add('hidden'));

  botForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('botName').value.trim() || 'Untitled Bot';
    const desc = document.getElementById('botDesc').value.trim();
    const runtime = document.getElementById('botRuntime').value;
    const fileInput = document.getElementById('botFile');
    const id = 'b' + Math.random().toString(36).slice(2,9);

    const localEntry = { id, name, desc, runtime, status: 'stopped', created: new Date().toISOString() };

    let created;
    if (fileInput && fileInput.files && fileInput.files.length) {
      const fd = new FormData();
      fd.append('name', name);
      fd.append('description', desc);
      fd.append('runtime', runtime);
      fd.append('file', fileInput.files[0]);
      // try persisting to backend, otherwise save local
      created = await persistCreate(fd, localEntry);
    } else {
      created = await persistCreate(null, localEntry);
    }

    // refresh local list based on backend or local
    await reloadAndRender();
    modal.classList.add('hidden');
    botForm.reset();
  });

  botsListEl.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if (!action || !id) return;

    if (action === 'start') {
      // set running locally, then try update backend
      const b = bots.find(x => x.id === id);
      if (!b) return;
      // optimistic UI
      b.status = 'running';
      renderBots();
      const ok = await persistUpdateStatus(id, 'running');
      if (!ok) {
        alert('Failed to start on backend. Status updated locally only.');
      }
      await reloadAndRender();
    } else if (action === 'logs') {
      const logs = await fetchLogs(id);
      logsContent.textContent = logs;
      logsModal.classList.remove('hidden');
    } else if (action === 'delete') {
      if (!confirm('Delete bot? This cannot be undone.')) return;
      const ok = await persistDelete(id);
      if (!ok) {
        alert('Failed to delete on backend.');
      }
      await reloadAndRender();
    } else if (action === 'download') {
      // If backend provides file download, open that endpoint. Otherwise, show info.
      if (BACKEND_URL) {
        const url = BACKEND_URL + `/api/bots/${encodeURIComponent(id)}/download`;
        window.open(url, '_blank');
      } else {
        alert('No backend configured. Use BACKEND_URL to enable file download.');
      }
    }
  });

  refreshBtn.addEventListener('click', () => reloadAndRender());

  // Logs modal controls
  closeLogs.addEventListener('click', () => logsModal.classList.add('hidden'));
  downloadLogs.addEventListener('click', () => {
    const text = logsContent.textContent || '';
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'logs.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  async function reloadAndRender() {
    await loadBots();
    renderBots();
  }

  // initial demo seed when no bots present
  async function ensureSeed() {
    if (BACKEND_URL) return;
    const data = loadLocal();
    if (!data || data.length === 0) {
      const seed = [
        { id: 'b1', name: 'EchoBot', desc: 'Replies with the same message', runtime: 'node', status: 'stopped', created: new Date().toISOString() },
        { id: 'b2', name: 'TimerBot', desc: 'Sends reminders', runtime: 'node', status: 'running', created: new Date().toISOString() }
      ];
      saveLocal(seed);
    }
  }

  // keyboard accessibility: close modals on ESC
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!modal.classList.contains('hidden')) modal.classList.add('hidden');
      if (!logsModal.classList.contains('hidden')) logsModal.classList.add('hidden');
    }
  });

  // initial load
  (async function init() {
    try {
      if (!BACKEND_URL) await ensureSeed();
      await reloadAndRender();
    } catch (e) {
      console.error('Initialization error', e);
      document.getElementById('main').insertAdjacentHTML('afterbegin', `<div style="background:#5a1d1d;padding:10px;border-radius:6px;margin-bottom:12px;color:#ffe6e6">Init error: ${escapeHTML(e.message)}</div>`);
    }
  })();
  </script>
</body>
</html>